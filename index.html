<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITOR DE LOGS - SISTEMA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Courier New', monospace;
            background: #000000;
            color: #00ff00;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            background: #000000;
            width: 100%;
            height: calc(100vh - 60px);
            position: relative;
            padding: 5px;
            overflow: hidden;
        }

        h3 {
            color: #00ff00;
            font-size: 24px;
            font-weight: bold;
            padding: 15px 20px;
            border: 3px solid #00ff00;
            background: linear-gradient(90deg, #001100 0%, #002200 100%);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 0;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
        }

        h3::before {
            content: '> ';
            color: #00ff00;
            text-shadow: 0 0 15px rgba(0, 255, 0, 1);
        }

        .card {
            position: absolute;
            display: flex;
            flex-direction: column;
            border: 2px solid #00ff00;
            background: #000000;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            resize: both;
            min-width: 300px;
            min-height: 200px;
        }

        .card.dragging {
            opacity: 0.8;
            cursor: move;
        }

        #card-logs {
            top: 5px;
            left: 5px;
            width: calc(50% - 7px);
            height: calc(50% - 7px);
        }

        #card-terminal {
            top: 5px;
            left: calc(50% + 3px);
            width: calc(50% - 8px);
            height: calc(50% - 7px);
        }

        .dashboard-iframe-livre {
            position: absolute;
            border: none;
            background: #000000;
        }

        #dashboard-mensal {
            top: calc(50% + 3px);
            left: 5px;
            width: calc(50% - 7px);
            height: calc(50% - 8px);
        }

        #dashboard-comercial {
            top: calc(50% + 3px);
            left: calc(50% + 3px);
            width: calc(50% - 8px);
            height: calc(50% - 8px);
        }

        .card-header {
            background: #00ff00;
            color: #000000;
            padding: 8px 15px;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.5);
            cursor: move;
            user-select: none;
        }

        .card-header:hover {
            background: #00ff88;
        }

        .card-content {
            flex: 1;
            overflow: auto;
            background: #000000;
        }

        .btn-fullscreen {
            background: #000000;
            color: #00ff00;
            border: 2px solid #000000;
            padding: 5px 12px;
            font-size: 13px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .btn-fullscreen:hover {
            background: #003300;
            color: #00ff00;
            border-color: #003300;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
            transform: scale(1.05);
        }

        #logs {
            background: #000000;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            color: #00ff00;
            margin: 0;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #00ff00 #000000;
        }

        /* Barra de rolagem estilizada estilo terminal - Webkit (Chrome, Edge, Safari) */
        #logs::-webkit-scrollbar {
            width: 10px !important;
            background: #000000 !important;
        }

        #logs::-webkit-scrollbar-track {
            background: #000000 !important;
            border-left: 2px solid #003300 !important;
            box-shadow: inset 0 0 5px rgba(0, 51, 0, 0.5) !important;
        }

        #logs::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00ff00 0%, #00aa00 50%, #00ff00 100%) !important;
            border-radius: 5px !important;
            border: 1px solid #003300 !important;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.7), inset 0 0 3px rgba(0, 255, 0, 0.3) !important;
            min-height: 30px;
        }

        #logs::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00ff00 0%, #00ff00 50%, #00ff00 100%) !important;
            box-shadow: 0 0 15px rgba(0, 255, 0, 1), inset 0 0 5px rgba(0, 255, 0, 0.5) !important;
        }

        #logs::-webkit-scrollbar-thumb:active {
            background: #00ff00 !important;
            box-shadow: 0 0 20px rgba(0, 255, 0, 1.2) !important;
        }

        #terminal,
        .terminal-output {
            background: #000000;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            color: #00ff00;
            margin: 0;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #00ff00 #000000;
        }

        /* Barra de rolagem estilizada para terminal - Webkit */
        #terminal::-webkit-scrollbar,
        .terminal-output::-webkit-scrollbar {
            width: 10px !important;
            background: #000000 !important;
        }

        #terminal::-webkit-scrollbar-track,
        .terminal-output::-webkit-scrollbar-track {
            background: #000000 !important;
            border-left: 2px solid #003300 !important;
            box-shadow: inset 0 0 5px rgba(0, 51, 0, 0.5) !important;
        }

        #terminal::-webkit-scrollbar-thumb,
        .terminal-output::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00ff00 0%, #00aa00 50%, #00ff00 100%) !important;
            border-radius: 5px !important;
            border: 1px solid #003300 !important;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.7), inset 0 0 3px rgba(0, 255, 0, 0.3) !important;
            min-height: 30px;
        }

        #terminal::-webkit-scrollbar-thumb:hover,
        .terminal-output::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00ff00 0%, #00ff00 50%, #00ff00 100%) !important;
            box-shadow: 0 0 15px rgba(0, 255, 0, 1), inset 0 0 5px rgba(0, 255, 0, 0.5) !important;
        }

        #terminal::-webkit-scrollbar-thumb:active,
        .terminal-output::-webkit-scrollbar-thumb:active {
            background: #00ff00 !important;
            box-shadow: 0 0 20px rgba(0, 255, 0, 1.2) !important;
        }

        .loading {
            color: #00ff00;
            animation: blink 1s infinite;
        }

        .error {
            color: #ff0000;
            font-weight: bold;
        }

        .empty {
            color: #00aa00;
        }

        .refresh-btn {
            background: #00ff00;
            color: #000000;
            border: 2px solid #00ff00;
            padding: 15px 30px;
            font-size: 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #000000;
            color: #00ff00;
        }

        .refresh-btn:active {
            background: #003300;
        }

        .refresh-btn:disabled {
            background: #003300;
            color: #005500;
            border-color: #005500;
            cursor: not-allowed;
        }

        .dashboard-iframe {
            width: 100%;
            height: 100%;
            flex: 1;
            border: none;
            background: #000000;
            min-height: 0;
            display: block;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Efeito de scan line do terminal */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 0, 0.03) 0px,
                rgba(0, 255, 0, 0.03) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <h3>SISTEMA DE MONITORAMENTO <span id="autoRefreshStatus" style="font-size: 14px; float: right; color: #00aa00;">‚Üª 10s</span></h3>

    <div class="container">
        <!-- Card de Logs -->
        <div id="card-logs" class="card">
            <div class="card-header">
                <span>[1] LOGS DO SISTEMA</span>
                <span style="font-size: 11px; color: #003300;">[ARRASTE PARA MOVER]</span>
            </div>
            <div class="card-content">
                <pre id="logs" class="loading">Inicializando sistema... Aguarde...</pre>
            </div>
        </div>

        <!-- Card Terminal -->
        <div id="card-terminal" class="card">
            <div class="card-header">
                <span>[2] TERMINAL DE COMANDO</span>
                <span style="font-size: 11px; color: #003300;">[ARRASTE PARA MOVER]</span>
            </div>
            <div class="card-content">
                <pre id="terminal" class="terminal-output">> TERMINAL PRONTO
> Aguardando comandos...
> Sistema operacional...
> 
> _</pre>
            </div>
        </div>

        <!-- Dashboard Mensal -->
        <iframe id="dashboard-mensal" src="https://williamprecs.github.io/mensalPowerBI/" frameborder="0" class="dashboard-iframe-livre"></iframe>

        <!-- Dashboard Comercial -->
        <iframe id="dashboard-comercial" src="https://williamprecs.github.io/comercialPrecsPowerBI/" frameborder="0" class="dashboard-iframe-livre"></iframe>
    </div>

    <script>
        const API_RELATIVE = "/api/logs"; // endpoint serverless na Vercel
        const API_FALLBACK = "https://auwb72k75qnn3ncgrchc6qpyv40kvdaa.lambda-url.sa-east-1.on.aws/"; // fallback direto
        const LOCAL_PROXY = "http://localhost:9000/api/logs"; // proxy local opcional
        const logsElement = document.getElementById("logs");

        // Fun√ß√£o para fazer requisi√ß√£o com timeout
        function fetchWithTimeout(url, options = {}, timeout = 10000) {
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Timeout')), timeout)
                )
            ]);
        }

        // Fun√ß√£o para fazer requisi√ß√£o tentando serverless /api/logs (Vercel), depois local proxy e fallback direto
        async function fazerRequisicao(url) {
            // 1. Serverless (Vercel) - mesmo dom√≠nio, sem CORS
            try {
                console.log("Tentando /api/logs (serverless)...");
                const resp = await fetchWithTimeout(API_RELATIVE, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                }, 10000);
                if (resp.ok) {
                    const data = await resp.json();
                    console.log("‚úÖ /api/logs funcionou!");
                    return data;
                }
            } catch (err) {
                console.log("Falha em /api/logs:", err.message);
            }

            // 2. Proxy local (√∫til para desenvolvimento)
            try {
                console.log("Tentando servidor proxy local...");
                const localResponse = await fetchWithTimeout(LOCAL_PROXY, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                }, 3000); // Timeout curto para detectar se est√° dispon√≠vel
                
                if (localResponse.ok) {
                    const data = await localResponse.json();
                    console.log("‚úÖ Servidor proxy local funcionou!");
                    return data;
                }
            } catch (localErr) {
                console.log("Servidor proxy local n√£o dispon√≠vel:", localErr.message);
            }

            // 3. Tenta requisi√ß√£o direta (fallback)
            try {
                console.log("Tentando requisi√ß√£o direta...");
                const directResponse = await fetchWithTimeout(API_FALLBACK, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors'
                }, 10000);
                
                if (directResponse.ok) {
                    const data = await directResponse.json();
                    console.log("‚úÖ Requisi√ß√£o direta funcionou!");
                    return data;
                }
            } catch (directErr) {
                console.log("Requisi√ß√£o direta falhou:", directErr.message);
            }

            // 3. Tenta proxies p√∫blicos como √∫ltimo recurso
            const proxies = [
                {
                    name: 'allorigins',
                    url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                    parse: async (response) => {
                        const data = await response.json();
                        if (data.contents) {
                            return JSON.parse(data.contents);
                        }
                        throw new Error("Resposta vazia do proxy");
                    }
                }
            ];

            for (const proxy of proxies) {
                try {
                    console.log(`Tentando proxy p√∫blico: ${proxy.name}...`);
                    
                    const proxyResponse = await fetchWithTimeout(proxy.url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    }, 20000); // 20 segundos de timeout
                    
                    if (!proxyResponse.ok) {
                        throw new Error(`Erro ${proxyResponse.status}: ${proxyResponse.statusText}`);
                    }
                    
                    const parsedData = await proxy.parse(proxyResponse);
                    console.log(`‚úÖ Proxy ${proxy.name} funcionou!`);
                    return parsedData;
                    
                } catch (err) {
                    console.warn(`‚ùå Proxy ${proxy.name} falhou:`, err.message);
                    continue;
                }
            }

            // Se tudo falhou
            throw new Error("N√£o foi poss√≠vel carregar os logs. Execute 'python proxy_server.py' para usar o servidor proxy local.");
        }

        function formatarLogsHTML(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return '<span style="color: #ffaa00;">>>> Nenhum evento encontrado</span>';
            }

            let html = '<div style="color: #00ff00;">' + "=".repeat(80) + '</div>\n';
            let eventos = [];
            let eventoAtual = null;

            for (let i = 0; i < data.length; i++) {
                const log = data[i];
                const msg = log.mensagem.trim();

                if (msg === "==================================================") {
                    if (eventoAtual) {
                        eventos.push(eventoAtual);
                    }
                    eventoAtual = { data: log.data, linhas: [] };
                    continue;
                }

                if (eventoAtual && msg !== "WEBHOOK RECEBIDO!" && 
                    !msg.includes("EVENTO COMPLETO") && 
                    !msg.includes("TIPO DO BODY") &&
                    !msg.includes("DADOS PARSEADOS") &&
                    !msg.includes("DADOS PARA PROCESSAMENTO") &&
                    !msg.includes("VALORES EXTRA√çDOS FINAIS") &&
                    !msg.includes(">>> FORMATO SIMPLES") &&
                    !msg.includes(">>> ID_NEGOCIO ENCONTRADO") &&
                    !msg.includes("DATA CONVERTIDA") &&
                    !msg.includes("OR√áAMENTO CONVERTIDO") &&
                    !msg.startsWith('"') &&
                    !msg.startsWith('{') &&
                    !msg.startsWith('}')) {
                    eventoAtual.linhas.push(msg);
                }
            }

            if (eventoAtual) {
                eventos.push(eventoAtual);
            }

            // Mostrar apenas os 3 √∫ltimos eventos
            const eventosRecentes = eventos.slice(-3);

            eventosRecentes.forEach((evento, idx) => {
                html += `\n<div style="margin-bottom: 15px;">`;
                html += `<div style="color: #00ffff; font-weight: bold; font-size: 16px;">>> WEBHOOK #${eventos.length - eventosRecentes.length + idx + 1} - ${evento.data}</div>`;
                html += `<div style="color: #00aa00; margin: 5px 0;">${"‚îÄ".repeat(70)}</div>`;

                evento.linhas.forEach(linha => {
                    if (linha.startsWith("ID NEG√ìCIO:")) {
                        const valor = linha.split(':')[1].trim();
                        html += `<div style="color: #ffff00; font-weight: bold;">  > ID NEG√ìCIO: <span style="color: #ffffff; font-size: 17px;">${valor}</span></div>`;
                    } else if (linha.startsWith("PROPRIET√ÅRIO:")) {
                        const valor = linha.split(':').slice(1).join(':').trim();
                        html += `<div style="color: #00ffaa;">  > PROPRIET√ÅRIO: <span style="color: #ffffff;">${valor}</span></div>`;
                    } else if (linha.startsWith("ORGANIZA√á√ÉO:")) {
                        const valor = linha.split(':').slice(1).join(':').trim();
                        html += `<div style="color: #00ffaa;">  > ORGANIZA√á√ÉO: <span style="color: #ffffff;">${valor}</span></div>`;
                    } else if (linha.startsWith("TRIBUNAL:")) {
                        const valor = linha.split(':')[1].trim();
                        html += `<div style="color: #00ffaa;">  > TRIBUNAL: <span style="color: #ffffff;">${valor}</span></div>`;
                    } else if (linha.startsWith("ID ETAPA:")) {
                        const valor = linha.split(':').slice(1).join(':').trim();
                        html += `<div style="color: #aaaaff;">  > ETAPA: <span style="color: #ffffff;">${valor}</span></div>`;
                    } else if (linha.startsWith("OR√áAMENTO:")) {
                        const valor = linha.split(':')[1].trim();
                        html += `<div style="color: #ffaa00;">  > OR√áAMENTO: <span style="color: #ffffff; font-weight: bold;">${valor}</span></div>`;
                    } else if (linha.startsWith("DATA:")) {
                        const valor = linha.split(':').slice(1).join(':').trim();
                        html += `<div style="color: #aaaaaa;">  > DATA: <span style="color: #ffffff;">${valor}</span></div>`;
                    } else if (linha.includes("SUCESSO")) {
                        html += `<div style="color: #00ff00; font-weight: bold; margin-top: 5px;">  >>> ${linha}</div>`;
                    }
                });

                html += `</div>`;
            });

            html += '<div style="color: #00ff00;">' + "=".repeat(80) + '</div>';
            return html;
        }

        function formatarLogs(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return "Sem logs nesse per√≠odo";
            }

            let resultado = [];
            let eventoAtual = null;
            let dadosNegocio = null;
            let jaMostrouDados = false;

            // Filtros para mensagens que n√£o queremos mostrar
            const filtrarMensagens = [
                "EVENTO COMPLETO:",
                "TIPO DO BODY:",
                "DADOS PARSEADOS:",
                "DADOS PARA PROCESSAMENTO:",
                "VALORES EXTRA√çDOS FINAIS:",
                ">>> FORMATO SIMPLES DETECTADO",
                ">>> ID_NEGOCIO ENCONTRADO - TENTANDO INSERIR NO BANCO",
                "DATA CONVERTIDA:",
                "OR√áAMENTO CONVERTIDO:",
                '"version":',
                '"routeKey":',
                '"rawPath":',
                '"rawQueryString":',
                '"headers":',
                '"requestContext":',
                '"accountId":',
                '"apiId":',
                '"domainName":',
                '"domainPrefix":',
                '"http":',
                '"method":',
                '"path":',
                '"protocol":',
                '"sourceIp":',
                '"userAgent":',
                '"requestId":',
                '"stage":',
                '"time":',
                '"timeEpoch":',
                '"isBase64Encoded":',
                '"x-amzn-',
                '"content-length":',
                '"content-type":',
                '"accept-encoding":',
                '"accept":',
                '"x-forwarded-',
                '"host":',
                '"{',
                '"}',
                '"},',
                '},',
                '"body":',
                'id_negocio:',
                'proprietario:',
                'data_evento:',
                'id_etapa:',
                'orcamento:',
                'organizacao:',
                'tribunal:',
            ];

            for (let i = 0; i < data.length; i++) {
                const log = data[i];
                const mensagem = log.mensagem.trim();
                const dataHora = log.data;

                // Pular mensagens filtradas
                if (filtrarMensagens.some(filtro => mensagem.includes(filtro))) {
                    continue;
                }

                // Detectar in√≠cio de novo evento
                if (mensagem === "==================================================") {
                    if (eventoAtual && dadosNegocio) {
                        // Mostrar resumo do evento anterior
                        resultado.push(`  ‚úÖ Processado com sucesso!`);
                        resultado.push("");
                    }
                    eventoAtual = dataHora;
                    dadosNegocio = null;
                    jaMostrouDados = false;
                    continue;
                }

                // Detectar WEBHOOK RECEBIDO
                if (mensagem === "WEBHOOK RECEBIDO!") {
                    resultado.push(`\nüì• WEBHOOK RECEBIDO - ${dataHora}`);
                    resultado.push("‚îÄ".repeat(70));
                    continue;
                }

                // Detectar BODY ENCONTRADO (extrair dados do neg√≥cio)
                if (mensagem.startsWith("BODY ENCONTRADO:")) {
                    try {
                        const jsonMatch = mensagem.match(/\{.*\}/);
                        if (jsonMatch) {
                            dadosNegocio = JSON.parse(jsonMatch[0]);
                        }
                    } catch (e) {
                        // Ignorar erro de parse
                    }
                    continue;
                }

                // Detectar informa√ß√µes importantes do neg√≥cio (mostrar apenas uma vez)
                if (!jaMostrouDados && dadosNegocio) {
                    resultado.push(`\n  üìã DADOS DO NEG√ìCIO:`);
                    resultado.push(`     ID: ${dadosNegocio.id_negocio || 'N/A'}`);
                    resultado.push(`     Propriet√°rio: ${dadosNegocio.proprietario || 'N/A'}`);
                    resultado.push(`     Organiza√ß√£o: ${dadosNegocio.organizacao || 'N/A'}`);
                    resultado.push(`     Tribunal: ${dadosNegocio.tribunal || 'N/A'}`);
                    resultado.push(`     Etapa: ${dadosNegocio.id_etapa || 'N/A'}`);
                    resultado.push(`     Or√ßamento: ${dadosNegocio.orcamento || 'N/A'}`);
                    resultado.push(`     Data: ${dadosNegocio.data || 'N/A'}`);
                    jaMostrouDados = true;
                    continue;
                }

                // Detectar informa√ß√µes do neg√≥cio (formato alternativo)
                if (mensagem.startsWith("ID NEG√ìCIO:") || 
                    mensagem.startsWith("PROPRIET√ÅRIO:") ||
                    mensagem.startsWith("ORGANIZA√á√ÉO:") ||
                    mensagem.startsWith("TRIBUNAL:") ||
                    mensagem.startsWith("ID ETAPA:") ||
                    mensagem.startsWith("OR√áAMENTO:") ||
                    mensagem.startsWith("DATA:")) {
                    if (!jaMostrouDados) {
                        // Extrair apenas o valor ap√≥s os dois pontos
                        const valor = mensagem.split(':').slice(1).join(':').trim();
                        const campo = mensagem.split(':')[0].trim();
                        if (!resultado.some(r => r.includes(campo))) {
                            resultado.push(`  ${mensagem}`);
                        }
                    }
                    continue;
                }

                // Detectar sucesso
                if (mensagem.includes("DADOS INSERIDOS NO BANCO COM SUCESSO")) {
                    continue; // J√° mostramos o sucesso no resumo
                }

                // Mostrar outras mensagens importantes (mas n√£o JSON)
                if (mensagem && 
                    !mensagem.startsWith('"') && 
                    !mensagem.endsWith('",') && 
                    !mensagem.endsWith('}') &&
                    !mensagem.startsWith('{') &&
                    mensagem.length > 2 &&
                    !mensagem.match(/^[\s\S]*\{[\s\S]*\}/)) {
                    resultado.push(`  ${mensagem}`);
                }
            }

            // Adicionar resumo do √∫ltimo evento se houver
            if (eventoAtual && dadosNegocio && !jaMostrouDados) {
                resultado.push(`\n  üìã DADOS DO NEG√ìCIO:`);
                resultado.push(`     ID: ${dadosNegocio.id_negocio || 'N/A'}`);
                resultado.push(`     Propriet√°rio: ${dadosNegocio.proprietario || 'N/A'}`);
                resultado.push(`     Organiza√ß√£o: ${dadosNegocio.organizacao || 'N/A'}`);
                resultado.push(`     Tribunal: ${dadosNegocio.tribunal || 'N/A'}`);
                resultado.push(`     Etapa: ${dadosNegocio.id_etapa || 'N/A'}`);
                resultado.push(`     Or√ßamento: ${dadosNegocio.orcamento || 'N/A'}`);
                resultado.push(`     Data: ${dadosNegocio.data || 'N/A'}`);
            }

            if (eventoAtual) {
                resultado.push(`\n  ‚úÖ Processado com sucesso!`);
            }

            return resultado.length > 0 ? resultado.join("\n") : "Sem logs relevantes para exibir";
        }

        async function carregarLogs() {
            logsElement.classList.remove("error", "empty");
            logsElement.classList.add("loading");
            logsElement.textContent = ">>> Carregando dados do sistema...\n>>> Conectando ao servidor...\n>>> Aguarde...";

            try {
                const data = await fazerRequisicao(API_FALLBACK);
                
                logsElement.classList.remove("loading");
                
                if (data && Array.isArray(data) && data.length > 0) {
                    logsElement.innerHTML = formatarLogsHTML(data);
                    // Rolagem suave e cont√≠nua para o final - m√∫ltiplas tentativas para garantir
                    setTimeout(() => {
                        logsElement.scrollTop = logsElement.scrollHeight;
                    }, 50);
                    setTimeout(() => {
                        logsElement.scrollTo({
                            top: logsElement.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 200);
                    setTimeout(() => {
                        logsElement.scrollTop = logsElement.scrollHeight;
                    }, 500);
                } else {
                    logsElement.classList.add("empty");
                    logsElement.innerHTML = '<span style="color: #ffaa00;">>>> SISTEMA: Nenhum evento registrado 10 minutos atr√°s.</span>\n<span style="color: #00aaff;">>>> STATUS: Aguardando novos eventos...</span>\n<span style="color: #00ff00;">>>> Pressione [F5] para atualizar.</span>';
                }
            } catch (err) {
                logsElement.classList.remove("loading");
                logsElement.classList.add("error");
                
                let mensagemErro = ">>> ERRO CRITICO: Falha na comunicacao com o servidor\n";
                mensagemErro += ">>> " + "=".repeat(74) + "\n\n";
                
                if (err.message.includes("Failed to fetch") || err.message.includes("NetworkError")) {
                    mensagemErro += ">>> DIAGNOSTICO:\n";
                    mensagemErro += ">>>   - Problema de conexao detectado\n";
                    mensagemErro += ">>>   - Servidor pode estar offline\n";
                    mensagemErro += ">>>   - Firewall bloqueando requisicao\n\n";
                    mensagemErro += ">>> ACOES RECOMENDADAS:\n";
                    mensagemErro += ">>>   1. Verificar conexao de rede\n";
                    mensagemErro += ">>>   2. Contatar administrador do sistema\n";
                    mensagemErro += ">>>   3. Pressionar [F5] para tentar novamente\n";
                } else {
                    mensagemErro += `>>> DETALHES: ${err.message}\n`;
                    mensagemErro += ">>> Pressione [F5] para tentar novamente\n";
                }
                
                mensagemErro += "\n>>> " + "=".repeat(74);
                
                logsElement.textContent = mensagemErro;
                console.error("Erro completo:", err);
            }
        }

        // Fun√ß√£o auxiliar para rolagem autom√°tica
        function rolarParaFinal() {
            const logsEl = document.getElementById('logs');
            if (logsEl) {
                // M√∫ltiplas tentativas para garantir rolagem
                setTimeout(() => {
                    logsEl.scrollTop = logsEl.scrollHeight;
                }, 50);
                setTimeout(() => {
                    logsEl.scrollTo({
                        top: logsEl.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 200);
                setTimeout(() => {
                    logsEl.scrollTop = logsEl.scrollHeight;
                }, 500);
            }
        }

        // Observador para detectar mudan√ßas no conte√∫do e rolar automaticamente
        const logsObserver = new MutationObserver(() => {
            rolarParaFinal();
        });

        // Iniciar observa√ß√£o quando o elemento estiver dispon√≠vel
        setTimeout(() => {
            const logsEl = document.getElementById('logs');
            if (logsEl) {
                logsObserver.observe(logsEl, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
            }
        }, 500);

        // Carregar logs ao carregar a p√°gina
        carregarLogs();

        // Auto-refresh a cada 10 segundos
        let autoRefreshInterval;
        let countdown = 10;

        function iniciarAutoRefresh() {
            // Limpa intervalo anterior se existir
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // Atualiza imediatamente
            carregarLogs();

            // Configura novo intervalo
            autoRefreshInterval = setInterval(() => {
                carregarLogs();
            }, 10000); // 10 segundos

            // Atualiza contador visual
            setInterval(() => {
                countdown--;
                if (countdown <= 0) countdown = 10;
                document.getElementById('autoRefreshStatus').textContent = `[‚Üª ${countdown}s]`;
            }, 1000);
        }

        // Inicia auto-refresh
        iniciarAutoRefresh();

        // Atalho F5 para atualizar manualmente
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5' || e.keyCode === 116) {
                e.preventDefault();
                countdown = 10; // Reseta contador
                carregarLogs();
            }
        });

        // Fun√ß√£o para abrir dashboard em tela cheia em nova aba
        function abrirFullscreen(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        // Sistema de drag and drop para os cards
        let draggedCard = null;
        let offsetX = 0;
        let offsetY = 0;

        document.querySelectorAll('.card').forEach(card => {
            const header = card.querySelector('.card-header');
            
            header.addEventListener('mousedown', function(e) {
                // N√£o arrastar se clicar no bot√£o
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                
                draggedCard = card;
                card.classList.add('dragging');
                
                const rect = card.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                
                card.style.zIndex = 1000;
            });
        });

        document.addEventListener('mousemove', function(e) {
            if (draggedCard) {
                const container = document.querySelector('.container');
                const containerRect = container.getBoundingClientRect();
                
                let newLeft = e.clientX - containerRect.left - offsetX;
                let newTop = e.clientY - containerRect.top - offsetY;
                
                // Limitar dentro do container
                newLeft = Math.max(0, Math.min(newLeft, containerRect.width - draggedCard.offsetWidth));
                newTop = Math.max(0, Math.min(newTop, containerRect.height - draggedCard.offsetHeight));
                
                draggedCard.style.left = newLeft + 'px';
                draggedCard.style.top = newTop + 'px';
            }
        });

        document.addEventListener('mouseup', function() {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                draggedCard.style.zIndex = 1;
                draggedCard = null;
            }
        });
    </script>
</body>
</html>

